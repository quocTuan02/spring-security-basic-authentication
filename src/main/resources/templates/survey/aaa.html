<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{/layout/layout :: main-fragment(
                                                ~{:: title},
                                                'short-header',
                                                'short-footer',
                                                ~{:: #css-resources},
                                                ~{:: #js-resources},
                                                ~{:: #main-content}
                                               )}">

<head>
    <title th:text="${questionnaire.name}">Khảo sát</title>

    <th:block id="css-resources">
        <link rel="stylesheet" type="text/css" th:href="@{/css/components/header.css}"/>
        <style>
            body {
                background: #f4f6f9;
            }
        </style>
    </th:block>
</head>
<body>
<main id="main-content">
    <div class="container card">
        <div class="card-body">
            <h1 class="text-center" th:text="${questionnaire.name}"></h1>
            <form th:action="@{'/survey/do/'+${questionnaire.id}}" th:method="post" id="do-survey">
                <ol>
                    <li th:each="ques : ${questionnaire.questionList}" class="list-item">
                        <input class="d-none"
                               th:value="${ques.id}"
                               type="hidden"
                               th:name="${'question[' + ques.id + '].id'}"
                               aria-label="">

                        <div class="form-group">
                            <label class="required-label" th:for="${'question_' + ques.id}" th:text="${ques.question}">question</label>
                            <textarea th:name="${'question[' + ques.id + '].answer'}"
                                      rows="3"
                                      aria-label=""
                                      th:id="${'question_' + ques.id}"
                                      class="form-control"></textarea>
                            <span class="invalid-feedback" th:id="${'invalid-feedback__' + ques.id}"></span>
                        </div>

                        <div class="form-group" th:if="${selectionList.contains(ques.getId())}">
                            <label class="required-label" th:for="${'question_' + ques.id}" th:text="${ques.question}">question</label>
                            <div>
                                <div th:each="option, index : ${ques.options}"
                                     class="form-check">
                                    <input class="form-check-input"
                                           th:value="${option}"
                                           type="radio"
                                           th:name="${'question[' + ques.id + '].answer'}"
                                           aria-label=""
                                           th:id="${'answer_' + index}"
                                           value="option1">
                                    <label class="form-check-label"
                                           th:text="${option}"
                                           th:for="${'answer_' + index}"></label>
                                </div>
                            </div>
                            <span class="invalid-feedback" th:id="${'invalid-feedback__' + ques.id}"></span>
                        </div>
                    </li>
                </ol>
                <button type="button"
                        form="do-survey"
                        class="btn btn-success btn-block btn-do-survey">submit</button>
            </form>
        </div>
    </div>
</main>

<th:block id="js-resources">
    <!-- AdminLTE App -->
    <script th:src="@{/adminlte/dist/js/adminlte.js}"></script>
    <script>
        $(document).on("click", ".btn-do-survey", function (e) {
            e.preventDefault();
            const form = $(this.form)
            $.ajax({
                url: form.attr("action"),
                type: 'POST',
                data: JSON.stringify(getFormData(form)),
                processData: false,
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    toastr.success(data.message);
                    setTimeout(function () {
                        window.location = "/"
                    }, 2000)
                },
                error: function (error) {
                    let data = error.responseJSON
                    if (data.errors instanceof Array) {
                        toastr.error(data.message);
                        $('.invalid-feedback').hide()
                        $.map(data.errors, function (e) {
                            let obj = $(`#invalid-feedback__${e.field.replaceAll(/[\[\].]/ig, "_")}`)
                            obj.show();
                            obj.text(e.message)
                        })
                    } else {
                        toastr.error(error.responseText);
                    }

                }
            });
        })
    </script>
</th:block>
</body>
</html>